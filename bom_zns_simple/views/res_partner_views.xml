<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- SAFE Contact Form View with ZNS Tab -->
    <record id="res_partner_form_zns_enhanced" model="ir.ui.view">
        <field name="name">res.partner.form.zns.enhanced</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">
            <!-- Add ZNS stat button - SAFE METHOD -->
            <div name="button_box" position="inside">
                <button type="object" name="action_send_zns" 
                        class="oe_stat_button" icon="fa-paper-plane">
                    <div class="o_stat_info">
                        <field name="zns_message_count" string="ZNS Messages"/>
                    </div>
                </button>
            </div>
            
            <!-- Add ZNS Tab - SAFE METHOD -->
            <notebook position="inside">
                <page string="Zalo ZNS" name="zns_messages">
                    <div class="alert alert-info">
                        <h4>📱 Contact ZNS Messages</h4>
                        <p>View and manage ZNS message history for this contact.</p>
                        <p><strong>Features:</strong></p>
                        <ul>
                            <li>📊 View all ZNS messages sent to this contact</li>
                            <li>📤 Send manual ZNS messages</li>
                            <li>📋 Track message status and delivery</li>
                            <li>🔍 Debug failed messages</li>
                        </ul>
                    </div>
                    
                    <group>
                        <button name="action_send_zns" 
                                string="📤 Send ZNS Message" 
                                type="object" 
                                class="btn-primary"
                                attrs="{'invisible': ['&amp;', ('mobile', '=', False), ('phone', '=', False)]}"/>
                        <div class="text-muted" attrs="{'invisible': ['|', ('mobile', '!=', False), ('phone', '!=', False)]}">
                            ⚠️ No phone number found. Please add mobile or phone number to send ZNS.
                        </div>
                    </group>
                    
                    <separator string="📋 ZNS Message History"/>
                    <field name="zns_message_ids" nolabel="1" readonly="1">
                        <tree decoration-success="status=='sent'" 
                              decoration-danger="status=='failed'" 
                              decoration-muted="status=='draft'"
                              create="false" edit="false">
                            <field name="create_date" string="Date"/>
                            <field name="template_id" string="Template"/>
                            <field name="status" string="Status"/>
                            <field name="sent_date" string="Sent Date"/>
                            <field name="sale_order_id" string="Sale Order" optional="hide"/>
                            <field name="invoice_id" string="Invoice" optional="hide"/>
                            <field name="message_id" string="Message ID" optional="hide"/>
                            <field name="error_message" string="Error" optional="hide"/>
                        </tree>
                        <form>
                            <sheet>
                                <div class="oe_title">
                                    <h1>
                                        <field name="template_id" readonly="1"/>
                                    </h1>
                                </div>
                                <group>
                                    <group>
                                        <field name="phone" readonly="1"/>
                                        <field name="status" readonly="1"/>
                                        <field name="create_date" readonly="1"/>
                                        <field name="sent_date" readonly="1"/>
                                    </group>
                                    <group>
                                        <field name="message_id" readonly="1"/>
                                        <field name="connection_id" readonly="1"/>
                                        <field name="sale_order_id" readonly="1"/>
                                        <field name="invoice_id" readonly="1"/>
                                    </group>
                                </group>
                                
                                <notebook>
                                    <page string="Parameters" attrs="{'invisible': [('parameters', '=', False)]}">
                                        <div class="alert alert-info">
                                            <h5>📊 Message Parameters</h5>
                                            <p>These are the parameters that were sent with this ZNS message:</p>
                                        </div>
                                        <field name="parameters" widget="ace" options="{'mode': 'json'}" readonly="1" nolabel="1"/>
                                    </page>
                                    
                                    <page string="Error Details" attrs="{'invisible': [('error_message', '=', False)]}">
                                        <div class="alert alert-danger">
                                            <h5>❌ Error Information</h5>
                                            <p>This message failed to send. Error details:</p>
                                        </div>
                                        <field name="error_message" readonly="1" nolabel="1"/>
                                        
                                        <div class="mt-3">
                                            <button name="send_zns_message" 
                                                    string="🔄 Retry Send" 
                                                    type="object" 
                                                    class="btn-warning"
                                                    confirm="Retry sending this ZNS message?"/>
                                        </div>
                                    </page>
                                </notebook>
                            </sheet>
                        </form>
                    </field>
                </page>
            </notebook>
        </field>
    </record>
    
    <!-- Contact ZNS Messages Action -->
    <record id="action_contact_zns_messages" model="ir.actions.act_window">
        <field name="name">Contact ZNS Messages</field>
        <field name="res_model">zns.message</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('partner_id', '!=', False)]</field>
        <field name="context">{'search_default_partner_id': active_id}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                📱 No ZNS messages for this contact yet!
            </p>
            <p>
                ZNS messages sent to this contact will appear here, including:
            </p>
            <ul>
                <li>Manual messages sent from contact form</li>
                <li>Automatic messages from sales orders</li>
                <li>Automatic messages from invoices</li>
            </ul>
        </field>
    </record>
</odoo>